// CFSync Fluidd Panel — injects live CFS slot status into Fluidd
//
// Usage (bookmarklet): set window.CFSYNC_URL before loading this script.
// The bookmarklet is generated by CFSync's own UI (footer link).
//
// What it does:
//   1. Finds Fluidd's "Runout Sensors" card (Vuetify v2 & v3)
//   2. Replaces its content with a compact CFS slot grid from CFSync's API
//   3. Polls /api/ui/state every 3 s; re-injects if Fluidd re-renders the card
//   4. Falls back to a floating panel if the card is not found after 15 s

(function () {
  'use strict';
  if (window.__cfsync_fluidd) return;
  window.__cfsync_fluidd = true;

  const BASE = (window.CFSYNC_URL || '').replace(/\/$/, '');
  if (!BASE) {
    console.error('[CFSync panel] window.CFSYNC_URL is not set. Load via the bookmarklet generated by CFSync.');
    return;
  }

  const POLL_MS = 3000;
  let slotsContainer = null;
  let statusEl = null;
  let pollTimer = null;
  let injected = false;

  // ---------- Styles ----------
  const STYLE_ID = 'cfsync-panel-styles';
  if (!document.getElementById(STYLE_ID)) {
    const s = document.createElement('style');
    s.id = STYLE_ID;
    s.textContent = [
      '#cfsync-panel{font-family:inherit}',
      '#cfsync-panel *{box-sizing:border-box}',
      '.cfsp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}',
      '.cfsp-title{font-weight:700;font-size:13px;opacity:.9}',
      '.cfsp-status{font-size:11px;padding:2px 7px;border-radius:4px;background:rgba(128,128,128,.15)}',
      '.cfsp-status.ok{background:rgba(31,157,85,.18);color:#1a9b50}',
      '.cfsp-status.err{background:rgba(214,69,69,.18);color:#c94444}',
      '.cfsp-boxes{display:flex;flex-direction:column;gap:6px}',
      '.cfsp-box{display:flex;align-items:stretch;gap:6px}',
      '.cfsp-box-lbl{width:38px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;opacity:.5}',
      '.cfsp-slots{display:flex;gap:4px;flex:1}',
      '.cfsp-slot{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 3px 5px;border-radius:8px;border:1px solid rgba(128,128,128,.2);min-width:0}',
      '.cfsp-slot.active{border-color:rgba(31,157,85,.6);background:rgba(31,157,85,.07)}',
      '.cfsp-dot{width:20px;height:20px;border-radius:50%;background:rgba(128,128,128,.25);border:1px solid rgba(255,255,255,.15);flex-shrink:0}',
      '.cfsp-id{font-size:10px;font-weight:700;opacity:.6;margin-top:1px}',
      '.cfsp-mat{font-size:10px;opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;text-align:center;line-height:1.2}',
      '.cfsp-pct{font-size:10px;opacity:.5}',
      '.cfsp-foot{margin-top:10px;text-align:right;font-size:11px;opacity:.4}',
      '.cfsp-foot a{color:inherit;text-decoration:none}',
      '.cfsp-foot a:hover{opacity:.75}',
      // Floating fallback panel
      '#cfsync-float{position:fixed;bottom:20px;right:20px;z-index:9999;min-width:260px;max-width:320px;',
      'border-radius:14px;border:1px solid rgba(128,128,128,.25);',
      'background:rgba(12,18,28,.94);backdrop-filter:blur(10px);',
      'color:#e8eef6;padding:12px 14px;box-shadow:0 8px 32px rgba(0,0,0,.45);font-size:13px}',
      '#cfsync-float-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}',
      '#cfsync-float-close{cursor:pointer;opacity:.5;font-size:16px;line-height:1;background:none;border:none;color:inherit;padding:0}',
      '#cfsync-float-close:hover{opacity:1}',
    ].join('');
    document.head.appendChild(s);
  }

  // ---------- Build panel content ----------
  function buildPanel() {
    const wrap = document.createElement('div');
    wrap.id = 'cfsync-panel';

    const hdr = document.createElement('div');
    hdr.className = 'cfsp-header';
    const title = document.createElement('span');
    title.className = 'cfsp-title';
    title.textContent = 'CFS Slots';
    statusEl = document.createElement('span');
    statusEl.className = 'cfsp-status';
    statusEl.textContent = 'connecting…';
    hdr.appendChild(title);
    hdr.appendChild(statusEl);
    wrap.appendChild(hdr);

    slotsContainer = document.createElement('div');
    slotsContainer.className = 'cfsp-boxes';
    wrap.appendChild(slotsContainer);

    const foot = document.createElement('div');
    foot.className = 'cfsp-foot';
    foot.innerHTML = '<a href="' + BASE + '" target="_blank">Open CFSync \u2197</a>';
    wrap.appendChild(foot);

    return wrap;
  }

  // ---------- Render API state into the panel ----------
  function renderState(state) {
    if (!slotsContainer) return;
    slotsContainer.innerHTML = '';

    const cfsSlots = state.cfs_slots || {};
    const localSlots = state.slots || {};
    const active = state.cfs_active_slot || null;
    const boxesMeta = (cfsSlots._boxes) ? cfsSlots._boxes : {};

    // Which boxes are connected?
    const connected = [];
    for (const n of ['1', '2', '3', '4']) {
      const b = boxesMeta[n];
      if (b && b.connected === true) connected.push(n);
    }
    if (!connected.length) connected.push('1', '2');

    for (const boxNum of connected) {
      const row = document.createElement('div');
      row.className = 'cfsp-box';

      const lbl = document.createElement('div');
      lbl.className = 'cfsp-box-lbl';
      lbl.textContent = 'Box ' + boxNum;
      row.appendChild(lbl);

      const slotWrap = document.createElement('div');
      slotWrap.className = 'cfsp-slots';

      for (const letter of ['A', 'B', 'C', 'D']) {
        const sid = boxNum + letter;
        const cfs = cfsSlots[sid] || {};
        const local = localSlots[sid] || {};
        const isActive = sid === active;

        const pod = document.createElement('div');
        pod.className = 'cfsp-slot' + (isActive ? ' active' : '');

        // Color swatch
        const dot = document.createElement('div');
        dot.className = 'cfsp-dot';
        const rawColor = (cfs.color || cfs.color_hex || local.color_hex || '').toString().toLowerCase();
        if (rawColor && cfs.present !== false) {
          dot.style.background = rawColor.startsWith('#') ? rawColor : '#' + rawColor;
        }
        pod.appendChild(dot);

        // Slot ID
        const idEl = document.createElement('div');
        idEl.className = 'cfsp-id';
        idEl.textContent = sid;
        pod.appendChild(idEl);

        // Material
        const mat = ((cfs.material || local.material) || '').toString().toUpperCase();
        if (mat) {
          const matEl = document.createElement('div');
          matEl.className = 'cfsp-mat';
          matEl.textContent = mat;
          pod.appendChild(matEl);
        }

        // Percent remaining
        if (cfs.percent != null) {
          const pctEl = document.createElement('div');
          pctEl.className = 'cfsp-pct';
          pctEl.textContent = cfs.percent + '%';
          pod.appendChild(pctEl);
        }

        slotWrap.appendChild(pod);
      }
      row.appendChild(slotWrap);
      slotsContainer.appendChild(row);
    }

    if (statusEl) {
      const ok = !!state.cfs_connected;
      statusEl.textContent = ok ? 'connected' : 'disconnected';
      statusEl.className = 'cfsp-status ' + (ok ? 'ok' : 'err');
    }
  }

  // ---------- Poll CFSync API ----------
  async function poll() {
    try {
      const r = await fetch(BASE + '/api/ui/state', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();
      renderState(j.result || j);
    } catch (_e) {
      if (statusEl) { statusEl.textContent = 'error'; statusEl.className = 'cfsp-status err'; }
    }
  }

  function startPolling() {
    if (pollTimer) return;
    poll();
    pollTimer = setInterval(poll, POLL_MS);
  }

  // ---------- Find Fluidd's Runout Sensors card ----------
  // Vuetify v2 uses .v-card__title; Vuetify v3 uses .v-card-title or .v-toolbar-title__placeholder
  const TITLE_SELECTORS = [
    '.v-card__title',
    '.v-card-title',
    '.v-toolbar-title__placeholder',
    '.v-toolbar-title',
  ];
  const TITLE_PATTERNS = ['runout', 'filament sensor', 'filament sensors'];

  function findCardBody() {
    for (const sel of TITLE_SELECTORS) {
      for (const el of document.querySelectorAll(sel)) {
        const txt = (el.textContent || '').trim().toLowerCase();
        if (TITLE_PATTERNS.some((p) => txt.includes(p))) {
          // Walk up to the Vuetify card root
          let node = el;
          for (let i = 0; i < 12; i++) {
            node = node.parentElement;
            if (!node) break;
            if (
              node.classList.contains('v-card') ||
              node.classList.contains('v-sheet') ||
              node.getAttribute('role') === 'group'
            ) {
              const body = node.querySelector('.v-card__text, .v-card-text');
              return body || node;
            }
          }
        }
      }
    }
    return null;
  }

  // ---------- Inject panel into target card ----------
  function inject() {
    const target = findCardBody();
    if (!target) return false;
    // Already injected into this element?
    if (target.querySelector('#cfsync-panel')) {
      startPolling();
      return true;
    }
    target.innerHTML = '';
    target.appendChild(buildPanel());
    injected = true;
    startPolling();
    return true;
  }

  // ---------- Floating fallback panel ----------
  function showFloat() {
    if (document.getElementById('cfsync-float')) return;

    const wrap = document.createElement('div');
    wrap.id = 'cfsync-float';

    const head = document.createElement('div');
    head.id = 'cfsync-float-head';
    const title = document.createElement('strong');
    title.textContent = 'CFSync — CFS Slots';
    const close = document.createElement('button');
    close.id = 'cfsync-float-close';
    close.textContent = '×';
    close.onclick = () => { wrap.remove(); clearInterval(pollTimer); pollTimer = null; };
    head.appendChild(title);
    head.appendChild(close);
    wrap.appendChild(head);

    const inner = document.createElement('div');
    inner.id = 'cfsync-panel';
    const hdr = document.createElement('div');
    hdr.className = 'cfsp-header';
    statusEl = document.createElement('span');
    statusEl.className = 'cfsp-status';
    statusEl.textContent = 'connecting…';
    hdr.appendChild(statusEl);
    inner.appendChild(hdr);
    slotsContainer = document.createElement('div');
    slotsContainer.className = 'cfsp-boxes';
    inner.appendChild(slotsContainer);
    const foot = document.createElement('div');
    foot.className = 'cfsp-foot';
    foot.innerHTML = '<a href="' + BASE + '" target="_blank">Open CFSync \u2197</a>';
    inner.appendChild(foot);
    wrap.appendChild(inner);

    document.body.appendChild(wrap);
    injected = true;
    startPolling();
  }

  // ---------- Init ----------
  function init() {
    if (inject()) return;

    // Watch for DOM changes — Fluidd is a SPA, cards may not exist yet
    const obs = new MutationObserver(() => {
      if (inject()) obs.disconnect();
    });
    obs.observe(document.body, { childList: true, subtree: true });

    // After 15 s give up on card replacement and show floating panel instead
    setTimeout(() => {
      obs.disconnect();
      if (!injected) {
        console.warn('[CFSync panel] Runout Sensors card not found — showing floating panel. Make sure the card is visible on the current Fluidd page.');
        showFloat();
      }
    }, 15000);
  }

  // Delay slightly to let Vue/Vuetify finish rendering
  setTimeout(init, 700);
})();
